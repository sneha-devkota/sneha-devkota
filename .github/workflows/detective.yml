name: 🕵️ Detective Contribution Animation
on:
  schedule:
    # Update every 12 hours
    - cron: "0 */12 * * *"  # Fixed: Added missing *

  # Allow manual trigger
  workflow_dispatch:

  # Update on push to main branch
  push:
    branches: [ main, master ]

jobs:
  generate-detective-animation:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # Removed cache since we're not using npm dependencies

      - name: 📦 Install dependencies
        run: |
          cd detective
          echo "No dependencies needed - using static HTML file"

      - name: 🕵️ Generate detective animation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd detective
          mkdir -p ../output   # ✅ ADDED LINE: Create output directory if it doesn't exist
          # Copy the HTML file to output as detective.html
          cp index.html ../output/index.html

          # If you want to keep the SVG generation, uncomment next line:
          # node detective.js

      - name: 📊 Check if animation was generated
        run: |
          if [ -f "output/index.html" ]; then
            echo "✅ Detective HTML animation generated successfully"
            ls -la output/
          else
            echo "❌ Detective animation not found"
            exit 1
          fi

      - name: 🔄 Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Detective Bot"
          git add output/index.html
          
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "🕵️ Update detective contribution animation $(date '+%Y-%m-%d %H:%M')"
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
            git push
          fi

            git push
          fi


      - name: 📈 Upload animation as artifact
        uses: actions/upload-artifact@v4
        with:
          name: detective-animation
          path: output/index.html
          retention-days: 30

      # Optional: Deploy to GitHub Pages
      - name: 🚀 Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
          publish_branch: gh-pages
